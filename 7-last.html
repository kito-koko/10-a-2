<!doctype html>
<meta charset="utf-8">
<title>7-5′ Platform Landing</title>
<canvas id="cv" width="1000" height="470" style="background:#0e1528"></canvas>
<script>
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');

// ── オブジェクト ─────────────────────────
const player = { x: 80, y: 260, w: 28, h: 36 };
const floor  = { x: 0,  y: 460, w: 1980, h: 40 };
const plat   = { x: 360, y: 240, w: 160, h: 16 }; 
const plat2  = { x: 100, y: 160, w: 160, h: 16 }; 
const plat3  = { x: 700, y: 360, w: 160, h: 16 }; 

// ── 物理パラメータ ────────────────────────
let vx = 0    
let vy = 0;
const speed = 240;   
const jump  = 300;   
const g     = 200;  
let isGrounded = false;
const bounce = 0.45;    
const impact = 250;     
friction = 0.88  

// ── 入力 ──────────────────────────────────
const keys = {};
addEventListener('keydown', e => keys[e.key] = true);   
addEventListener('keyup',   e => keys[e.key] = false);  
addEventListener('keydown', e=>{
  // 地上にいるときだけジャンプ
  if (e.code === 'Space' && isGrounded) vy = -jump;     
});


// ── 衝突処理：床 ───────
function collideWithFloor(){
  const bottom = player.y + player.h;
  if (bottom > floor.y) {
    player.y = floor.y - player.h;
    if (Math.abs(vy) > impact) {      
      vy = -vy * bounce; 
      isGrounded = false;
    } else {
      vy = 0;
      isGrounded = true;   
    }
  } else {
    isGrounded = false;
  }
}


// ── 当たり判定ユーティリティ（AABB） ──────
function aabb(r1, r2) {
  return (r1.x < r2.x + r2.w && r1.x + r1.w > r2.x &&
          r1.y < r2.y + r2.h && r1.y + r1.h > r2.y);
}

// ── 衝突処理：浮遊足場（上からのみ着地） ──
function collideWithPlatform(platObject, dt) { // ★変更：足場オブジェクトを引数で受け取る
  // 今フレームの矩形
  const pNow = { x: player.x, y: player.y, w: player.w, h: player.h };
  if (!aabb(pNow, platObject)) return; // そもそも重なっていない

  // 前フレームの“底”が足場の上面より上にあったなら「上から来た」とみなす
  const prevBottom = (player.y - vy * dt) + player.h;
  const platformTop = platObject.y;

  if (prevBottom <= platformTop && vy >= 0) {
    // 上から着地
    player.y = platformTop - player.h; // 吸着
    vy = 0;
    isGrounded = true;
  } else {
    // 横や下から来た場合は「乗れない」簡易仕様：今回は処理しない（すり抜け）
  }
}

// ── 位置更新 ──────────────────────────────────
function update(dt){
  // 入力 → 水平方向速度（簡略：即時切替）
  if (keys['ArrowLeft'])  vx = -speed;
  else if (keys['ArrowRight']) vx =  speed;
    else if (isGrounded) vx *= friction;  
    
  player.x += vx * dt;
  vy += g * dt;            // 重力で速度が増える
  player.y += vy * dt;     // 位置更新

  // 衝突判定（毎フレーム isGrounded をリセットしてから判定）
  isGrounded = false;     
  collideWithFloor();
  
  // ★変更：既存の足場と、新たに追加した足場の両方と衝突判定を行う
  collideWithPlatform(plat, dt);
  collideWithPlatform(plat2, dt); 
  collideWithPlatform(plat3, dt);
}

// ── 描画 ──────────────────────────────────
function draw() {
  ctx.clearRect(0,0,cv.width,cv.height);

  // 床
  ctx.fillStyle = '#F5DEB3';
  ctx.fillRect(floor.x, floor.y, floor.w, floor.h);

  // 浮遊足場 1
  ctx.fillStyle = '#F5DEB3';
  ctx.fillRect(plat.x, plat.y, plat.w, plat.h);
  
  // ★追加：浮遊足場 2 の描画
  ctx.fillStyle = '#F5DEB3';
  ctx.fillRect(plat2.x, plat2.y, plat2.w, plat2.h);

ctx.fillStyle = '#F5DEB3';
  ctx.fillRect(plat3.x, plat3.y, plat3.w, plat3.h);

  // プレイヤー（地上:水色／空中:黄）
  ctx.fillStyle = isGrounded ? '#7E90B0' : '#E6BAD8';
  ctx.fillRect(player.x, player.y, player.w, player.h);

  // HUD
  ctx.fillStyle = '#cbd5e1';
  ctx.font = '12px ui-monospace,monospace';
  ctx.fillText(`vy=${vy.toFixed(1)} grounded=${isGrounded}`, 8, 16);
}

// ── ループ ─────────────────────────────────
let last = performance.now();
function loop(now) {
  const dt = (now - last) / 1000; last = now;

  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>